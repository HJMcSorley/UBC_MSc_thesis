---
title: "Reproducible data analysis: thesis data analysis and visualization"
subtitle: "Pacific Maritime forWater Masters Project (NSERC forWater)"
author: "Hannah J McSorley"
date: "2020-01-31"
output:
  word_document:
    toc: false
    reference_docx: word-styles-document_thesis.docx
bibliography: library.bib  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r packages}

# load packages
suppressPackageStartupMessages(library(tidyverse))  # includes: dplyr, ggplot2, purrr, readr, forcats, lubridate
suppressPackageStartupMessages(library(knitr))      # tidy tables
suppressPackageStartupMessages(library(gridExtra))  # rapid runoff hydrograph/precip plots
suppressPackageStartupMessages(library(grid))       # for rapid runoff plots
suppressPackageStartupMessages(library(ggplot2))    # plots
suppressPackageStartupMessages(library(viridis))    # nice colours for plots gradient fills

```

# General Introduction / context

Surface water is the primary source of drinking water for over 85% of the Canadian population and in the province of British Columbia, approximately 80% of drinking water originates from forested headwaters [@Pike2010]. Forests offer a variety of ecosystem services (e.g. biodiversity) and also slow and filter runoff, resulting in high quality source water supply [@Dudley2003]. Surface water quality varies over time and space due to climate, weather, and physical characteristics of the watershed (such as topography, land cover and geology) with terrestrial sediments, nutrients, and organic material (e.g. leaf litter) entering surface water through erosion and precipitation events [@Pike2010; @Johnson1997; @Delpla2016; @HealthCanada2019; @Yang2015]. 

In Canada, all source water is treated to meet Health Canada drinking water quality guidelines, which specify allowable levels of biological, physical and chemical parameters that are safe for human use and consumption [@BC2019]. Drinking water treatment processes vary from chlorination alone (at the simplest level) to multiple stages of chemically assisted filtration in combination with advanced oxidative processes. Water treatment protocols differ between communities based on source water quality, infrastructure capabilities, budget, and regional water quality regulations [REFS]. Chlorination remains the most widely used method of inactivating potentially harmful microorganisms, whether it stands alone as the primary and sole treatment protocol, or is used in combination with other processes [@HealthCanada2006; HealthLinkBC2018]. 
 
When natural source water is chlorinated, chemical reactions with natural organic matter (NOM) can form a variety of chlorinated organic compounds which are broadly classified as disinfection by-products (DBPs). [@Richardson2007; @Delpla2016; @HealthCanada2019; @Yang2015; @Hua2015; @StdMet2000]. A number of DBPs are included in Health Canada's drinking water quality guidelines, and have maximum allowable concentrations in treated water due to their potential or known health affects (i.e. genotoxicity and carcinogenicity) [@Richardson2007; @BC2019].   
 
The molecular composition and physical structure of NOM influence its reactivity, therefore different types of NOM have different DBP formation potentials (DBP-FP) [@Delpla2016; @Yang2015; @HealthCanada2019]. NOM is a diverse family of molecules, which contain nitrogen, silica, oxygen and hydrogen but are composed primarily of organic carbon, therefore organic carbon is often measured as a proxy for NOM concentration [@HealthCanada2019]. Total organic carbon (TOC) is composed of particulate and dissolved fractions (POC and DOC, respectively). Generally, DOC comprises a larger component of TOC relative to POC, and is more likely to generate DBPs during treatment [@ REFS]. Because NOM is a precursor for DBPs, source water quality guidelines in British Columbia specify that TOC should remain below 4mg/L in source water [@BC2019]. 

``` {r input 01_files}
# assign timezone
TZ <- "Etc/GMT+8"

# File Inputs
#Results of data wrangling (01) were saved as .csv files for tidy loading. 
# read all compiled data files & format

# sampleresults df
# compiled sample analyses results (wide)
sampleresults <- read_csv("R-outputs_UBC-forWater-MSc_HMc/01_Lab-analyses_sample-results_wide.csv",
                          col_names = TRUE) %>%   
  mutate(trip = factor(trip, levels = c(1:22)),
         site = factor(site), 
         sample_type = factor(sample_type),
         sample = factor(sample),
         #dt_sampled = lubridate::ymd(dt_sampled),
         analysis = factor(analysis),
         #trip_end = lubridate::ymd(trip_end),
         three_seasons = factor(three_seasons),
         two_seasons = factor(two_seasons))


# odyssey_data df
# stage data compiled with interval/trip
odyssey_data <- read_csv("R-outputs_UBC-forWater-MSc_HMc/01_Odyssey-stage_compiled.csv",
                         col_names = TRUE) %>% 
   mutate(source = factor(source),
         interval = factor(interval),
         DateTime = lubridate::ymd_hms(DateTime, tz = TZ))
  

# precip_data df
# 2018-2020 weather station data compiled and formatted
precip_data <- read_csv("R-outputs_UBC-forWater-MSc_HMc/01_FWx-PrecipTemp_compiled.csv", 
                        col_names = TRUE,
                        col_types = list("c", "c", "d", "d", "d", "d", "d", "d", "d", "d", "d", "d")) %>% 
  mutate(StationName = factor(StationName),
         DateTime = lubridate::ymd_hms(DateTime, tz = TZ))             

```

```{r samples count}
# Data Summarization

# primary synoptic sampling sites (n > 1)
# 15 sites total
# 229 synoptic grab samples collected
synoptic_grabcount_df <- sampleresults %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Grab") %>%
  group_by(site = forcats::fct_explicit_na(site)) %>% 
  summarise(grab_sample_count = n()) %>% 
  filter(grab_sample_count > 1) %>% 
  mutate(what = "synoptic grab count") %>% 
  ungroup()

# create a subset dataframe for the synoptically sampled sites 
# see 'snoptic_grabcount_df)
synopticfilter <- sampleresults %>% filter(site == "West-Leech"|
                                             site == "Tunnel"|
                                             site == "Cragg-crk"|
                                             site == "Leech-head"|
                                             site == "Weeks-out"|
                                             site == "Chris-crk"|
                                             site == "Jarvis"|
                                             site == "Lazar"|
                                             site == "Rithet"|
                                             site == "Deception-res"|
                                             site == "West-Jordan"|
                                             site == "Leech-downstreamconf"|
                                             site == "Judge-crk"|
                                             site == "Deception-crk"|
                                             site == "Boneyard") %>% 
  mutate(site = factor(site, levels = c("Weeks-out", "Chris-crk", "Leech-head", "Cragg-crk", "West-Leech", "Tunnel",
                                        "Leech-downstreamconf", "Boneyard", 
                                        "Deception-crk", "Judge-crk", "Rithet", "Lazar", "Jarvis", "West-Jordan")))

# filter for the six install sites for tidier calling
sixfilter <- sampleresults %>% filter(site == "Weeks-out" |
                                        site == "Leech-head" |
                                        site == "Chris-crk" |
                                        site == "Cragg-crk" |
                                        site == "West-Leech"| 
                                        site == "Tunnel") %>% 
  mutate(site = factor(site, levels = c("Weeks-out", "Chris-crk", "Leech-head", "Cragg-crk", "West-Leech", "Tunnel")))


# how many of each sample_type are there at the 6 main sites?
# 324 samples overall
# 153 Grab (some ~30 duplicates) 
# 171 Rack
sixsites_samplecount_df <- sixfilter %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Rack" | sample_type == "Grab") %>%
  group_by(site, sample_type) %>%   
  summarise(number_of_samples = n()) 
# write_csv(sixsites_samplecount_df, path = "R-outputs_UBC-forWater-MSc_HMc/summ_sample-DOCcount.csv", na = "NA")  

# How many samples were collected overall
# 400 total
sample_count_df <- sampleresults %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Rack" | sample_type == "Grab") %>%
  group_by(sample_type) %>% 
  summarise(sample_count = n()) %>% 
  mutate(what = "all analysed samples") %>% 
  ungroup()
# write_csv(sample_count_df, path = "R-outputs_UBC-forWater-MSc_HMc/summ_allsamples-DOCcount-df.csv", na = "NA") 


# How many synoptic site samples were collected overall
# 386 total
synoptic_count_df <- synopticfilter %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Rack" | sample_type == "Grab") %>%
  group_by(sample_type) %>% 
  summarise(sample_count = n()) %>% 
  mutate(what = "synoptic count (rack and grabs)") %>% 
  ungroup()
# write_csv(synoptic_count_df, path = "R-outputs_UBC-forWater-MSc_HMc/synopticsamples-DOCcount-df.csv", na = "NA")


# ------
# 15 synoptic sites (including the install sites)
## 215 synoptic grab samples (44 outside of the six sites)
# 6 installation sites
## 324 samples were collected/analyzed at the 6 installation sites:
### 153 Grab (39 replicates/treatability) 
### 171 Rack
# an additional 18 grab samples were collected (synoptically) but as one-offs (totaling 229 grabs overall)
# in total 400 samples were collected and analyzed

# ------

```

# Sample Analyses

Water samples were collected and transported via coolers (on ice) to UBC's EcoHydrology Lab for analysis of dissolved organic carbon (DOC) concentrations and indicators of NOM character. Samples were also measured for phosphate concentration using a field portable colourmetric test kit (HACH); each sample had phosphate concentrations below detectable limits (XXXXXX mg/L).   

## Quantifying dissolved organic carbon (DOC)
For quantification of DOC, samples were analyzed for non-purgeable organic carbon (NPOC) via High-Temperature Combustion Method (5310-B) on a Shimadzu TOC-V [@StdMet2000]. For this method, samples were filtered with 0.45-micron PES filters, acidified to bring pH below 2, then sparged with hydrocarbon-free air to drive off inorganic carbon. Following sparging, samples were combusted to convert all organic carbon to carbon dioxide which was measured with a non-dispersive infrared gas detector to quantify the DOC content of the sample. This method represents a direct method of measuring DOC, as all natural organic carbon in the sample is measured. Although small volatile organic compounds would be removed in the sparging process, most NOM compounds are of higher molecular weight and it is unlikely that NOM DOC analytes would be lost [@StdMet2000; @Matilainen2011].

## Qualifying dissolved organic matter (proxy measures of DOC)
Spectral properties of sample NOM were analyzed using a "Spectro::lyser" spectrophotometer (S::can, Vienna, Austria) which measures turbidity and the chromophoric portion of organic matter to estimate concentrations of total organic carbon (TOC), dissolved organic carbon (DOC), as well as nitrate-nitrogen (NO~3~^-^-N). A caveat to interpreting the Spectrolyser results is that, for NOM to be detected by UV-Vis absorption the molecules must absorb UV or Visible light (not all molecules do). UV-Vis absorption occurs only if the applied energy (light) can be absorbed by the molecule; in general, this required the presence of aromatic bonds (i.e. conjugated pi-bond systems in the molecule, a.k.a chromophore). Therefore, UV-Vis absorption is proportional to the molecule's degree of aromaticity and is a measure of chromophoric DOM (CDOM).

The Spectrolyser outputs a fingerprint file containing absorbance values at all of the wavelengths monitored. These absorbance values can provide information about the character of NOM. For example, the ratio of the slope between 275-295nm and the slope from 350-400nm ("slope ratio (SR)"), is commonly used as an indicator of molecular weight.
Based on full scan data from the Spectrolyser (250-700nm), several indices of NOM character were determined {_in progress_}:

- SUVA~254~ --- Specific UV absorbance at 254nm is the ratio of UV absorption (spectral absorbance coefficient, SAC, m^-1^) at 254nm, normalized to DOC concentration (mgL^-1^). SUVA~254~ correlates strongly with DOM aromaticity [@Helms2008].

- Spectral slopes --- it has been shown that UV spectral slopes are useful semi quantitative indicators for assessing NOM molecular weights [@Helms2008]: 

  *Spectral slopes 1 & 2 --- the slope of spectral intensity over the shorter wavelength range of 275-295nm (1) and longer wavelength range of 350-400nm (2). 
  *Slope Ratio --- The ratio of spectral slopes 1 and 2, correlates well with CDOM molecular weight [@Helms2008]


# Data Visualization & Summaries

## Leech DOC concentrations overview

Table 1 and Figure 1 show DOC concentrations were highest at Weeks Creek, the headwaters monitoring point for a sub-basin which included Weeks Lake and surrounding wetlands. On average, Chris Creek DOC concentration was 51% lower than Weeks creek. Below the confluence of Weeks and Chris Creek, the head of Leech River had a mean DOC concentration slightly less than the average of the two headwater tributaries. West Leech River had higher DOC than Cragg Creek by about 20%. Below the confluences of West Leech and Cragg Creek, the Leech Tunnel site had DOC concentrations that were 54% lower than the average at the Leech head, and closer to those of Cragg Creek.

```{r DOC-space plot all, fig.width=7, fig.height=5}

# Boxplot with jitter scatter 
# DOC by site 
# grab and rack combined (all)
sixfilter %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Grab" | sample_type == "Rack") %>% 
  ggplot(aes(x = site, y = NPOC_ppm, fill = site)) +
  geom_boxplot(alpha = 0.5) +
  geom_jitter(aes(fill = site), alpha = 0.8, shape = 21) +
  scale_fill_brewer(palette="Accent") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(caption = "Fig.1 DOC concentration across six sites over 15 months (324 samples)", 
       x = "", y = "DOC (mg/L)")
#ggsave(path = "R-outputs_UBC-forWater-MSc_HMc/", filename = "Fig1_DOC_boxplot-alltogether.png")

# summary table
sixfilter %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Grab" | sample_type == "Rack") %>% 
  group_by(site) %>% 
  summarize(DOC_mean = mean(NPOC_ppm),
            DOC_sd = sd(NPOC_ppm),
            RSD = (DOC_sd/DOC_mean)*100) %>% 
  ungroup() %>% 
  knitr::kable(digits = 1, 
               col.names = c("site", "mean DOC (mg/L)", "std.dev. (± mg/L)", "RSD (%)"),
               caption = "Table 1: summary of DOC concentrations at the six main sites")

```

At the six sub-basin monitoring sites, vertical racks were installed to collect samples as the rivers rose in response to precipitation events.
 
These vertical racks collected samples on the rising hydrograph limb, which has been shown to have higher DOC concentration that non-storm flow [@Yang2015; @Raymond2016; @Raymond2010]. As the vertical racks require a hydrologic response to collect samples, they are only applicable during the wet season. Comparing wet season Grab samples to those collected on Racks confirms that the rack samplers were able to capture more samples, and many during periods with higher DOC concentrations (Fig.2).  

```{r DOC space-time boxplot, fig.width=8, fig.height=6}
# Boxplot with jitter scatter 
# site vs DOC
# facet wrap by sample type
sixfilter %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Rack" | sample_type == "Grab",
                two_seasons == "wet") %>% 
  ggplot(aes(x = site, y = NPOC_ppm, fill = site)) +
  geom_boxplot(alpha = 0.5) +
  geom_jitter(aes(fill = site), alpha = 0.8, shape = 21) +
  scale_fill_brewer(palette="Accent") +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90)) +
  facet_wrap(~sample_type, ncol = 2, nrow = 1) +  
  labs(caption = "Fig.2 West season DOC concentration by sample type:\n Grab samples (n = 112) and rising limb Rack samples (n = 166)", x = "", y = "DOC (mg/L)")
#ggsave(path = "R-outputs_UBC-forWater-MSc_HMc/", filename = "Fig2_DOC_boxplot-Grab-vs-Rack.png") 
```

```{r sample_type ridge plots, include=FALSE}

# density ridge 
# wrap by sample_type

sixfilter %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Rack" | sample_type == "Grab" & sample == "Grab") %>%
  ggplot(aes(x = NPOC_ppm, y = fct_rev(site))) +
  ggridges::geom_density_ridges(aes(fill = site), alpha = 0.4) +
  facet_wrap(~sample_type, ncol = 1, nrow = 2) +
  scale_fill_brewer(palette="Accent") +
  theme_bw() +
  labs(y = "", x = "DOC (mg/L)", 
       caption = "Density distribution plots of DOC concentration at six sites based on sampling method (Grab: n = 153, Rack: n = 171)") +
  theme(legend.position = "none") 
#ggsave(path = "R-outputs_UBC-forWater-MSc_HMc/", filename = "DOC_ridgeplot_GvsR.png")


```

##  Sampling campaign
Four hundred water sample were collected and analyzed for DOC over a 16 month study period (October 2018 to February 2020). The synoptic grab-sampling program was enhanced by the collection of stormflow on the six vertical sampling racks. In total, 171 samples were collected on vertical Racks, 215 Grab samples were collected at 15 synoptically sampled sites (which included the six installation sites), and an additional 14 Grab samples were collected opportunistically at one-off sites across the water supply area. Figure 3 shows DOC concentrations across the 15 synoptically sampled sites over the study period (n=386). 

```{r DOC scatter plots by sample_type, fig.width=8, fig.height=6}

# DOC over time by sample_type
synopticfilter %>% 
  dplyr::filter(analysis == "DOC",
                sample_type == "Grab" | sample_type == "Rack") %>%
  mutate(trip_end = factor(trip_end)) %>% 
  ggplot(aes(x = trip_end, y = NPOC_ppm)) + 
  geom_jitter(aes(fill = sample_type), size = 3, shape = 22, alpha = 0.75) +
  scale_fill_manual(values = c("#D55E00", "#999999")) +
  theme_bw() +
  labs(y = "DOC (mg/L)", x = "", fill = "sample type",
       caption = "Fig.3 DOC over fifteen months (Oct 2018 to Jan 2020) in 386 samples \n(synoptic Grab samples (n = 215) and vertical Rack collection (n = 171)") +
  theme(axis.text.x = element_text(angle = 90), legend.position = "top")
#ggsave(path = "R-outputs_UBC-forWater-MSc_HMc/", filename = "Fig3_DOC_scatter-total-sampletype.png") 
```
Over the study period, DOC concentrations decreased throughout the wet season, and increased again during the dry summer months (Fig.3). This seasonal DOC concentration pattern was clear at each of the six installation locations in the LWSA (Fig.4).

```{r DOC over time at 6 sites by sample_type, fig.width=8, fig.height=6}
# at each of the six sites (DOC over time)
sixfilter %>% 
  dplyr::filter(analysis == "DOC",
                sample_type == "Rack" | sample_type == "Grab") %>%
  mutate(trip = factor(trip)) %>% 
  ggplot(aes(x = trip, y = NPOC_ppm)) +
  geom_jitter(aes(fill = sample_type), size = 2, shape = 21, alpha = 0.6) +
  scale_fill_manual(values = c("#D55E00", "#999999")) +
  theme_bw() +
  labs(y = "DOC (mg/L)", x = "field trip", fill = "sample type:",
       caption = "Fig.4 DOC over fifteen months (Oct 2018 to Jan 2020) in 324 samples \n(Grab samples (n = 153) and vertical Rack collection (n = 171)") +
  facet_wrap(~site, ncol = 2, nrow = 3) +
  theme(axis.text.x = element_text(angle = 90), legend.position = "top")
#ggsave(path = "R-outputs_UBC-forWater-MSc_HMc/", filename = "Fig4_DOC_facet-scatter-sampletype.png") 

```


## Seasonal examination of DOC & DOM dynamics 

In this section, a categorical season ID was used to assess temporal variations in DOC. Seasons were separated based on months of the year: the wet season was October through May, and the dry season was June until October.

* Precipitation data will be employed to operationally separate season (data obtained January 31, 2020 from CRD).

These seasonal plots show data from both Rack and Grab samples in order to include the full available range of concentrations. 

In the wet season, DOC concentrations generally increased during stormflow (relative to between-storm peaks) _{data not shown here}_, and progressively dropped over the course of the wet season. During dry season baseflow, DOC concentration was elevated compared to late wet season DOC (Fig.5).

```{r seasonal DOC table and ridge plot, fig.width=8, fig.height=6}

# density ridge plots (facet wrap by season)
sixfilter %>% 
  dplyr::filter(analysis == "DOC",
                sample_type == "Rack" | sample_type == "Grab") %>%
  ggplot(aes(x = NPOC_ppm, y = fct_rev(site))) +
  ggridges::geom_density_ridges(aes(fill = site), alpha = 0.4) +
  facet_wrap(~two_seasons, ncol = 1, nrow = 2) +
  scale_fill_brewer(palette="Accent") +
  theme_bw() +
  labs(y = "", x = "DOC (mg/L)", 
       caption = "Fig.5 Density distribution of DOC concentration by season (dry: n = 45, wet: n = 240)") +
  theme(legend.position = "none") 
#ggsave(path = "R-outputs_UBC-forWater-MSc_HMc/", filename = "Fig5_DOC_ridgeplot-seasonal.png") 
```

At each of the six sub-basin monitoring locations, mean DOC was higher during the dry season than during the wet season (Table 2, Fig.8). There was less variation in dry season DOC concentrations at each site also (Table 2), which could be due to actual reduction in variance in the absence of stormflow pulses and also due to fewer dry season samples (n = 46) compared to wet season samples (n = 278). 

```{r table 2}
# summary table
sixfilter %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Grab" | sample_type == "Rack") %>% 
  group_by(site, two_seasons) %>% 
  summarize(DOC_mean = mean(NPOC_ppm),
            DOC_sd = sd(NPOC_ppm),
            RSD = (DOC_sd/DOC_mean)*100) %>% 
  ungroup() %>% 
  knitr::kable(digits = 1, col.names = c("season", "site", "mean DOC (mg/L)", "std.dev. (± mg/L)", "RSD (%)"),
               label = "Table 2: DOC concentrations by season at the six main sites")

# Boxplot with jitter scatter (DOC by season)
sixfilter %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Rack" | sample_type == "Grab") %>% 
  ggplot(aes(x = site, y = NPOC_ppm, fill = site)) +
  geom_boxplot(alpha = 0.5) +
  geom_jitter(aes(fill = site), alpha = 0.8, shape = 21) +
  scale_fill_brewer(palette="Accent") +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90)) +
  facet_wrap(~two_seasons, ncol = 2, nrow = 1) +  
  labs(caption = "Fig.8 DOC concentration by season (dry: n = 46, wet: n = 278)", 
       x = "", y = "DOC (mg/L)")
# ggsave(path = "R-outputs_UBC-forWater-MSc_HMc/", filename = "Fig8_DOC_boxplot-seasonal.png") 
```

To remove the variance of stormflow DOC concentrations, Table 2-B and Figure 9 shows seasonal concentrations based only on Grab samples (excludes 166 stormflow samples collected by Racks).

```{r table 2-B}
# summary table (grabs only)
sixfilter %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Grab") %>% 
  group_by(site, two_seasons) %>% 
  summarize(DOC_mean = mean(NPOC_ppm),
            DOC_sd = sd(NPOC_ppm),
            RSD = (DOC_sd/DOC_mean)*100) %>% 
  ungroup() %>% 
  knitr::kable(digits = 1, col.names = c("season", "site", "mean DOC (mg/L)", "std.dev. (± mg/L)", "RSD (%)"),
               label = "Table 2-B: Grab sample DOC concentrations by season at the six main sites")

# Boxplot with jitter scatter (DOC by season)
sixfilter %>% 
  dplyr::filter(analysis == "DOC", 
                sample_type == "Grab") %>% 
  ggplot(aes(x = site, y = NPOC_ppm, fill = site)) +
  geom_boxplot(alpha = 0.5) +
  geom_jitter(aes(fill = site), alpha = 0.8, shape = 21) +
  scale_fill_brewer(palette="Accent") +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90)) +
  facet_wrap(~two_seasons, ncol = 2, nrow = 1) +  
  labs(caption = "Fig.9 DOC concentration by season (dry: n = 45, wet: n = 112)", 
       x = "", y = "DOC (mg/L)")
# ggsave(path = "R-outputs_UBC-forWater-MSc_HMc/", filename = "DOC_boxplot-seasonal.png") 


```



```{r seasonal plots, include=FALSE}
# Boxplot with jitter scatter 
sampleresults %>% 
  dplyr::filter(site == "Weeks-out" |
                  site == "Leech-head" |
                  site == "Chris-crk" |
                  site == "Cragg-crk" |
                  site == "West-Leech"| 
                  site == "Tunnel" |
                  site == "Rithet" |
                  site == "Judge-crk", 
                analysis == "DOC", 
                sample_type == "Grab" & sample == "Grab") %>% 
  mutate(site = factor(site, 
                       levels = c("Weeks-out", "Chris-crk", "Leech-head", "Cragg-crk", "West-Leech", "Tunnel", "Rithet", "Judge-crk"))) %>% 
  ggplot(aes(x = site, y = NPOC_ppm, fill = site)) +
  geom_boxplot(alpha = 0.5) +
  geom_jitter(aes(fill = site), alpha = 0.8, shape = 21) +
  scale_fill_brewer(palette="Accent") +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90)) +
  facet_wrap(~two_seasons, ncol = 2, nrow = 1) +  
  labs(caption = "DOC concentrations in the Leech and two main tribs to the Sooke Reservoir", 
       x = "", y = "DOC (mg/L)")
# ggsave(path = "R-outputs_UBC-forWater-MSc_HMc/", filename = "DOC_boxplot-seasonalwithSooketribs.png") 


# --- DOC facet wrap scatter plots ---
# I don't think these are good graphics
# Scatter main sites including sooke tribs
sampleresults %>% 
  dplyr::filter(site == "Weeks-out" |
                  site == "Leech-head" |
                  site == "Chris-crk" |
                  site == "Cragg-crk" |
                  site == "West-Leech"| 
                  site == "Tunnel" |
                  site == "Rithet" |
                  site == "Judge-crk", 
                analysis == "DOC", 
                sample_type == "Grab" & sample == "Grab") %>% 
  mutate(site = factor(site, 
                       levels = c("Weeks-out", "Chris-crk", "Leech-head", "Cragg-crk", "West-Leech", "Tunnel", "Rithet", "Judge-crk"))) %>% 
  ggplot(aes(x = dt_sampled, y = NPOC_ppm, fill = sample_type)) +
  geom_jitter(aes(fill = site), alpha = 0.8, shape = 21, size = 3) +
  theme_bw() +
  viridis::scale_fill_viridis(discrete = TRUE) +
  labs(caption = "DOC concentrations", x = "", y = "DOC (mg/L, as NPOC)") +
  theme(axis.text.x = element_text(angle = 90), legend.position = "none") +
  facet_wrap(~site, ncol = 2, nrow = 4)
# this is not a useful plot

```


### Plots of DOC & proxy

DOC was quantified as non-purgeable organic carbon (NPOC) on the Shimadzu TOC auto analyzer, and samples were also measured on a Spectrolyser spectrophotometer. A spectrophotometer can only measure the fraction of organic matter that is able to absorb UV or Visible light, and therefore DOC measured on the Spectrolyser was a measure of CDOM and an indicator of aromaticity (molecular character).

Figure 6 shows results from all samples comparing DOC concentrations (as NPOC, direct measure) to CDOM concentrations (UV-Vis, proxy measure of DOC). There was a strong seasonal separation of the relationship between these two measurements. These results indicate a seasonally-driven physiochemical difference in the aquatic NOM in this drinking water supply area.

```{r DOC vs CDOM, fig.width=7, fig.height=5}

# all sites: DOC vs CDOM
synopticfilter %>% 
  filter(analysis == "DOC",
         sample_type == "Rack" | sample_type == "Grab" & sample == "Grab") %>%
  mutate(site = factor(site, exclude = "Lab"),
         site = factor(site)) %>% 
  ggplot(aes(x = NPOC_ppm, y = DOCeq_ppm, fill = two_seasons)) +  
  geom_jitter(shape = 21, size = 3, alpha = 0.6) +
  xlim(0, 20) +
  ylim(0, 20) +
  geom_abline(slope = 1, intercept = 0, lty = "dotted",) +  
  scale_fill_manual(values = c("#f4AB0E", "#09A4D2")) + 
  theme_bw() +
  theme(legend.position = "top") +
  labs(x = "DOC (mg/L as NPOC)", y = "CDOM (mg/L from UV-Vis) ", fill = "sampling season:",
       caption = "Fig.6 DOC concentration from direct measure versus CDOM from UV-Vis absorbance") 
#ggsave(path = "R-outputs_UBC-forWater-MSc_HMc/", filename = "Fig6_DOCvsCDOM_scatterplot.png") 
```

Figure 7 shows the same DOC-CDOM comparison from Figure 6, isolated to the six sub-basin monitoring sites. The seasonal relationship appears similar for the six sites.

```{r DOC vs CDOM at 6 sites, fig.width=8, fig.height=6}
# six primary sites: DOC vs CDOM
sixfilter %>% filter(analysis == "DOC",
         sample_type == "Rack" | sample_type == "Grab" & sample == "Grab") %>%
  ggplot(aes(x = NPOC_ppm, y = DOCeq_ppm, fill = two_seasons)) +
  geom_jitter(shape = 21, size = 2, alpha = 0.6) +
  xlim(0, 20) +
  ylim(0, 20) +
  geom_abline(slope = 1, intercept = 0, lty = "dotted",) + 
  scale_fill_manual(values = c("#f4AB0E", "#09A4D2")) +
  facet_wrap(~site, nrow = 3, ncol = 2) +
  theme_bw() +
  theme(legend.position = "top") +
  labs(x = "DOC (mg/L as NPOC)", y = "CDOM (mg/L from UV-Vis)", fill = "sampling season:",
       caption = "Fig.7 Six installation sites showing DOC concentration versus CDOM from UV-Vis absorbance")
#ggsave(path = "R-outputs_UBC-forWater-MSc_HMc/", filename = "Fig7_DOCvsCDOM_6sites_scatterplot.png") 
```

In progress: analysis of spectral fingerprint data for slope ratio indices, which will help to elucidate seasonal DOM character shifts.


```{r SUVA plots -- in progress, include=FALSE}

# SUVA vs time
sampleresults %>% 
  filter(sample_type == "Rack" | sample_type == "Grab" & sample == "Grab") %>%
  mutate(site = factor(site, exclude = "Lab"),
         site = factor(site),
         trip_end = factor(trip_end)) %>% 
  ggplot(aes(x = trip_end, y = SUVA, fill = two_seasons)) +  
  geom_jitter(shape = 21, size = 3, alpha = 0.6) +
  scale_fill_manual(values = c("#f4AB0E", "#09A4D2")) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x = "DOC (mg/L as NPOC)", y = "SUVA", fill = "sampling season:",
       caption = "Grab sample spectral concentrations (via spectrophotometry)...")



# --- UV-Vis parameters
# --- Spectrolyser data with TOCV data
sampleresults %>% 
  filter(sample_type == "Grab" & sample == "Grab",
         site == "Weeks-out" |
           site == "Leech-head" |
           site == "Chris-crk" |
           site == "Cragg-crk" |
           site == "West-Leech"| 
           site == "Tunnel") %>%
  mutate(site = factor(site, levels = c("Weeks-out", "Chris-crk", "Leech-head", "Cragg-crk", "West-Leech", "Tunnel"))) %>%
  ggplot(aes(x = NPOC_ppm, y = NO3.Neq_ppm, fill = two_seasons)) +  # exchange NPOC_ppm with DOCeq_ppm -- similar pattern but split seasonally
  geom_point(shape = 21, size = 2) +
  geom_abline(lty = "dotted", slope = 1, intercept = 0) +
  scale_fill_manual(values = c("#5B99CC", "#3B3838", "#f4AB0E")) +
  facet_wrap(~site, nrow = 3, ncol = 2) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x = "C-DOM (proxy DOC, mg/L)", y = "nitrate (mg/L)", fill = "sampling season:",
       caption = "Grab sample DOC and nitrate concentrations (via spectrophotometry)...")

# --- Spectrolyser data - SAC254_Abs.m vs SAC436_Abs.m
sampleresults %>% 
  filter(sample_type == "Grab" & sample == "Grab",
         site == "Weeks-out" |
           site == "Leech-head" |
           site == "Chris-crk" |
           site == "Cragg-crk" |
           site == "West-Leech"| 
           site == "Tunnel") %>%
  mutate(site = factor(site, levels = c("Weeks-out", "Chris-crk", "Leech-head", "Cragg-crk", "West-Leech", "Tunnel"))) %>%
  ggplot(aes(x = SAC254_Abs.m, y = SAC436_Abs.m, fill = two_seasons)) +  # exchange NPOC_ppm with DOCeq_ppm -- similar pattern but split seasonally
  geom_point(shape = 21, size = 2) +
  geom_abline(lty = "dotted", slope = 1, intercept = 0) +
  scale_fill_manual(values = c("#5B99CC", "#3B3838", "#f4AB0E")) +
  facet_wrap(~site, nrow = 3, ncol = 2) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x = "SAC254_Abs.m", y = "SAC436_Abs.m", fill = "sampling season:",
       caption = "Grab sample spectral concentrations (via spectrophotometry)...")

# --- Spectrolyser data - NPOC vs SAC254_Abs.m
sampleresults %>% 
  filter(sample_type == "Grab" & sample == "Grab",
         site == "Weeks-out" |
           site == "Leech-head" |
           site == "Chris-crk" |
           site == "Cragg-crk" |
           site == "West-Leech"| 
           site == "Tunnel") %>%
  mutate(site = factor(site, levels = c("Weeks-out", "Chris-crk", "Leech-head", "Cragg-crk", "West-Leech", "Tunnel"))) %>%
  ggplot(aes(x = NPOC_ppm, y = SAC254_Abs.m, fill = two_seasons)) +  # exchange NPOC_ppm with DOCeq_ppm -- similar pattern but split seasonally
  geom_point(shape = 21, size = 2) +
  scale_fill_manual(values = c("#5B99CC", "#3B3838", "#f4AB0E")) +
  facet_wrap(~site, nrow = 3, ncol = 2) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x = "DOC (mg/L as NPOC)", y = "CDOM abs (SAC 254 /m)", fill = "sampling season:",
       caption = "Grab sample spectral concentrations (via spectrophotometry)...")



# all sites DOC versus SAC 254
sampleresults %>% 
  filter(sample_type == "Grab" & sample == "Grab") %>%
  ggplot(aes(x = NPOC_ppm, y = SAC254_Abs.m, fill = two_seasons)) +  # exchange NPOC_ppm with DOCeq_ppm -- similar pattern but split seasonally
  geom_point(shape = 21, size = 2) +
  scale_fill_manual(values = c("#5B99CC", "#3B3838", "#f4AB0E")) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x = "DOC (mg/L as NPOC)", y = "CDOM abs (SAC 254 /m)", fill = "sampling season:",
       caption = "Grab sample spectral concentrations (via spectrophotometry)...")


# --- RACK SAMPLES


# --- DOC versus CDOM on rack samples
sampleresults %>% 
  filter(sample_type == "Rack",
         site == "Weeks-out" |
           site == "Leech-head" |
           site == "Chris-crk" |
           site == "Cragg-crk" |
           site == "West-Leech"| 
           site == "Tunnel") %>%
  mutate(site = factor(site, levels = c("Weeks-out", "Chris-crk", "Leech-head", "Cragg-crk", "West-Leech", "Tunnel"))) %>%
  ggplot(aes(x = NPOC_ppm, y = DOCeq_ppm, fill = sample)) +  
  geom_point(shape = 21, size = 2) +
  theme_bw() +
  facet_wrap(~site, nrow = 3, ncol = 2) +
  viridis::scale_fill_viridis(discrete = TRUE) 
labs(x = "DOC (mg/L as NPOC)", y = "CDOM (mg/L)", fill = "Rack Position:",
     caption = "Rack sample DOC concentration based on direct (combustion measuring all non-purgeable organic carbon) and proxy (spectrophotometry measuring chromophoric fraction) methods of quantification...")

# --- DOC versus NO3- on rack samples
sampleresults %>% 
  filter(sample_type == "Rack",
         site == "Weeks-out" |
           site == "Leech-head" |
           site == "Chris-crk" |
           site == "Cragg-crk" |
           site == "West-Leech"| 
           site == "Tunnel") %>%
  mutate(site = factor(site, levels = c("Weeks-out", "Chris-crk", "Leech-head", "Cragg-crk", "West-Leech", "Tunnel"))) %>%
  ggplot(aes(x = NPOC_ppm, y = NO3.Neq_ppm, fill = sample)) +  # exchange NPOC_ppm with DOCeq_ppm -- similar pattern but split seasonally
  geom_point(shape = 21, size = 2) +
  theme_bw() +
  facet_wrap(~site, nrow = 3, ncol = 2) +
  viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = "DOC (mg/L as NPOC)", y = "nitrate (mg/L)", fill = "Rack Position:",
       caption = "Rack sample DOC and nitrate concentrations (via spectrophotometry)...")

# --- facet wrap scatter plots of conc --- ## W.I.P. ###
# DOC over time (by trip) -- try mutating in a month-year for clarity
sampleresults %>% 
  dplyr::filter(sample_type == "Rack",
                site == "Weeks-out" |
                  site == "Leech-head" |
                  site == "Chris-crk" |
                  site == "Cragg-crk" |
                  site == "West-Leech"| 
                  site == "Tunnel") %>%
  mutate(site = factor(site, levels = c("Weeks-out", "Chris-crk", "Leech-head", "Cragg-crk", "West-Leech", "Tunnel"))) %>%
  mutate(trip = factor(trip, levels = (1:22))) %>% 
  ggplot(aes(x = trip, y = NPOC_ppm, fill = sample)) +
  geom_jitter(shape = 21, size = 2) +
  #facet_wrap(~site, ncol = 2, nrow = 3) +
  viridis::scale_fill_viridis(discrete = TRUE) 
  #geom_jitter() +
  #theme_bw() +
  #labs(y = "DOC (mg/L)", x = "time span", colour = "sample type:") +
  #theme(legend.position = "top",
  # axis.text.x = element_text(angle = 90))   # rotate tick labels for clarity
  
```

```{r stage plots, include=FALSE}

# --- facet wrap scatter plots of river stage over time (hydrograph) ---
odyssey_data %>% 
  mutate(source = factor(source, levels = c("Weeks", "ChrisCrk", "LeechHead", "CraggCrk", "WestLeech",  "Tunnel"))) %>%
  mutate(interval = factor(interval, levels = (1:22))) %>% 
  ggplot(aes(x = DateTime, y = stage_cm)) + 
  geom_line(aes(colour = source)) +
  theme_bw() +
  labs(y = "stage (cm)", x = "") +
  facet_wrap(~source, ncol = 1) +
  theme(legend.position = "none")  

```



# References